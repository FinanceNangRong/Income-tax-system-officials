<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานเจ้าหนี้อัตโนมัติ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif; 
            transition: background-color 0.3s ease;
            font-size: 13px; 
            color: #000000; /* กำหนดสีพื้นฐานเป็นสีดำ */
        }
        .dark body { background-color: #0f172a; color: #ffffff; }
        .dark .bg-white { background-color: #1e293b; border-color: #334155; }
        .dark .text-black { color: #ffffff !important; } /* เมื่อเป็น Dark Mode ให้เป็นสีขาว */
        .dark .bg-gray-50 { background-color: #0f172a; }
        .dark .border-gray-100 { border-color: #334155; }
        .dark input, .dark select { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
        
        .table-bordered th, .table-bordered td { 
            border: 1px solid #cbd5e1; 
            padding: 6px 8px !important; 
        }
        .dark .table-bordered th, .table-bordered td { border: 1px solid #334155; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        @media print {
            @page { size: landscape; margin: 1cm; }
            body { background-color: white !important; padding: 0 !important; -webkit-print-color-adjust: exact; font-size: 10pt !important; color: black !important; }
            .no-print { display: none !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th, td { border: 1px solid #000 !important; padding: 4px !important; }
        }

        @keyframes pulse-emerald {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .sync-active { animation: pulse-emerald 2s infinite; }
    </style>
</head>
<body class="p-3 md:p-6 bg-gray-50 transition-colors duration-300 text-black">

    <div class="max-w-7xl mx-auto space-y-4">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 no-print">
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-bold text-black">ระบบรายงานเจ้าหนี้ ✨</h1>
                    <span id="autoSyncBadge" class="flex items-center gap-1 bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-[10px] font-bold">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full sync-active"></span>
                        Auto-Sync On
                    </span>
                </div>
                <p class="text-indigo-600 font-semibold text-xs italic">อัปเดตข้อมูลอัตโนมัติจาก Google Sheets</p>
            </div>
            <div class="mt-3 md:mt-0 flex flex-wrap gap-2 justify-center">
                <button id="syncCloudBtn" class="flex items-center gap-1.5 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg transition shadow-sm text-xs">
                    <i data-lucide="refresh-cw" class="w-4 h-4" id="syncIcon"></i>
                    <span>รีเฟรชตอนนี้</span>
                </button>
                <label class="flex items-center gap-1.5 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg transition shadow-sm cursor-pointer text-xs">
                    <i data-lucide="file-up" class="w-4 h-4"></i>
                    <span>อัปโหลด Excel</span>
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                </label>
                <button id="darkModeToggle" class="p-1.5 rounded-lg border border-gray-200 dark:border-slate-700 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
                    <i data-lucide="moon" id="moonIcon" class="w-4 h-4"></i>
                    <i data-lucide="sun" id="sunIcon" class="w-4 h-4 hidden"></i>
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-3 no-print">
            <div class="flex items-center justify-between mb-1 border-b pb-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="filter" class="text-indigo-500 w-4 h-4"></i>
                    <h2 class="font-bold text-sm text-black">ค้นหาและกรองข้อมูล</h2>
                </div>
                <span id="lastUpdateText" class="text-[10px] text-gray-500 font-bold">อัปเดตล่าสุด: กำลังโหลด...</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">ชื่อบริษัท/เจ้าหนี้</label>
                    <div class="relative">
                        <i data-lucide="building-2" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"></i>
                        <input type="text" id="searchCreditor" placeholder="ค้นหา..." class="pl-8 pr-3 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full focus:ring-2 focus:ring-indigo-500 text-black">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">เลขที่ใบแจ้งหนี้</label>
                    <div class="relative">
                        <i data-lucide="hash" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"></i>
                        <input type="text" id="searchInvoice" placeholder="ค้นหา..." class="pl-8 pr-3 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full focus:ring-2 focus:ring-indigo-500 text-black">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">สถานะการชำระ</label>
                    <select id="filterStatus" class="px-3 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full focus:ring-2 focus:ring-indigo-500 text-black">
                        <option value="All">ทุกสถานะ</option>
                        <option value="Paid">จ่ายครบแล้ว</option>
                        <option value="Unpaid">ยังไม่จ่าย</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">ประเภทค่าใช้จ่าย</label>
                    <div class="relative group">
                        <div id="expenseTypeDropdownBtn" class="flex justify-between items-center px-3 py-1.5 border border-gray-300 rounded-lg cursor-pointer text-xs bg-white dark:bg-slate-800">
                            <span id="selectedExpenseLabel" class="truncate text-black font-semibold">ทั้งหมด</span>
                            <i data-lucide="chevron-down" class="w-3.5 h-3.5 text-black"></i>
                        </div>
                        <div id="expenseMenu" class="hidden absolute left-0 right-0 mt-1 bg-white dark:bg-slate-800 border border-gray-300 rounded-lg shadow-xl z-50 max-h-48 overflow-y-auto custom-scrollbar p-1.5">
                            <label class="flex items-center gap-2 p-1.5 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-md cursor-pointer border-b mb-1">
                                <input type="checkbox" id="checkAllExpenses" checked class="w-3.5 h-3.5 rounded text-indigo-600 focus:ring-indigo-500">
                                <span class="text-[11px] font-bold text-black">เลือกทั้งหมด</span>
                            </label>
                            <div id="expenseCheckboxes" class="space-y-0.5"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">วันที่ตรวจรับของ</label>
                    <div class="flex items-center gap-1.5">
                        <input type="date" id="dateReceiveStart" class="px-2 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full text-black">
                        <span class="text-gray-400">-</span>
                        <input type="date" id="dateReceiveEnd" class="px-2 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full text-black">
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-1">
                    <label class="text-[10px] font-bold text-black uppercase">วันที่ชำระเงิน</label>
                    <div class="flex items-center gap-1.5">
                        <input type="date" id="datePaymentStart" class="px-2 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full text-black">
                        <span class="text-gray-400">-</span>
                        <input type="date" id="datePaymentEnd" class="px-2 py-1.5 border border-gray-300 rounded-lg outline-none text-xs w-full text-black">
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 no-print text-black">
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">ยอดหนี้รวม</p>
                <h3 id="statTotal" class="text-lg font-bold">0.00</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">จ่ายแล้ว</p>
                <h3 id="statPaid" class="text-lg font-bold text-green-700">0.00</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-orange-500">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">ปรับปรุง</p>
                <h3 id="statAdjustment" class="text-lg font-bold text-orange-700">0.00</h3>
            </div>
            <div class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-red-500">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">คงเหลือ</p>
                <h3 id="statBalance" class="text-lg font-bold text-red-700">0.00</h3>
            </div>
        </div>

        <!-- Summary Table -->
        <div id="summarySection" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-3 border-b bg-indigo-50 dark:bg-slate-800 flex items-center justify-between no-print">
                <div class="flex items-center gap-1.5 font-bold text-xs text-black">
                    <i data-lucide="list-checks" class="w-4 h-4 text-indigo-600"></i>
                    สรุปตามประเภทค่าใช้จ่าย
                </div>
                <button onclick="window.print()" class="flex items-center gap-1.5 bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 transition shadow-sm text-[11px] font-semibold">
                    <i data-lucide="printer" class="w-3.5 h-3.5"></i>
                    พิมพ์รายงาน
                </button>
            </div>
            <div class="p-3 overflow-x-auto">
                <table class="w-full text-xs text-left table-bordered border-collapse text-black">
                    <thead class="bg-gray-100 dark:bg-slate-700">
                        <tr class="text-black font-bold text-[11px] uppercase">
                            <th class="p-2 text-center w-12">ลำดับ</th>
                            <th class="p-2">ประเภทค่าใช้จ่าย</th>
                            <th class="p-2 text-center w-24">รายการ</th>
                            <th class="p-2 text-right">ยอดรวม</th>
                            <th class="p-2 text-right text-green-700">จ่ายแล้ว</th>
                            <th class="p-2 text-right text-orange-600">ปรับปรุง</th>
                            <th class="p-2 text-right text-red-700 font-bold">คงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody" class="divide-y divide-gray-200"></tbody>
                    <tfoot class="bg-gray-50 dark:bg-slate-800 font-bold border-t-2 border-gray-300">
                        <tr id="summaryTableFooter"></tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Details Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden no-print">
            <div class="p-3 border-b bg-gray-50 dark:bg-slate-800">
                <h3 class="font-bold text-xs text-black flex items-center gap-1.5">
                    <i data-lucide="file-text" class="w-4 h-4 text-indigo-500"></i>
                    รายละเอียดรายการทั้งหมด
                </h3>
            </div>
            <div class="p-3 overflow-x-auto">
                <table class="w-full text-left text-[11px] table-bordered border-collapse text-black">
                    <thead>
                        <tr class="text-black font-bold bg-gray-100 dark:bg-slate-700">
                            <th class="p-2 w-20">วันที่รับ</th>
                            <th class="p-2">ชื่อเจ้าหนี้ / เลขบิล</th>
                            <th class="p-2 text-right">จำนวนเงิน</th>
                            <th class="p-2 text-right text-green-700">จ่าย</th>
                            <th class="p-2 text-right text-orange-600">ปรับ</th>
                            <th class="p-2 text-right text-red-700">คงเหลือ</th>
                            <th class="p-2 text-center w-20">วันที่ชำระ</th>
                            <th class="p-2 text-center w-16">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-200">
                        <tr><td colspan="8" class="p-6 text-center text-gray-500 italic">กำลังดึงข้อมูลอัตโนมัติ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statusMsg" class="hidden fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-[60] text-xs animate-bounce"></div>

    <script>
        let rawData = [];
        let filteredDataGlobal = [];
        let selectedExpenseTypes = new Set();
        let syncInterval;
        
        lucide.createIcons();

        window.onload = function() {
            fetchFromCloud(); 
            startAutoSync(); 
        };

        function startAutoSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                fetchFromCloud(true);
            }, 300000); // 5 mins
        }

        const dropBtn = document.getElementById('expenseTypeDropdownBtn');
        const menu = document.getElementById('expenseMenu');
        dropBtn.onclick = (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); };
        document.onclick = () => menu.classList.add('hidden');

        function parseThaiDate(dateStr) {
            if (!dateStr || dateStr === '-' || dateStr === '0') return null;
            const months = { 'ม.ค.': 0, 'ก.พ.': 1, 'มี.ค.': 2, 'เม.ย.': 3, 'พ.ค.': 4, 'มิ.ย.': 5, 'ก.ค.': 6, 'ส.ค.': 7, 'ก.ย.': 8, 'ต.ค.': 9, 'พ.ย.': 10, 'ธ.ค.': 11 };
            const parts = String(dateStr).trim().split(' ');
            if (parts.length < 3) return null;
            const day = parseInt(parts[0]);
            const month = months[parts[1]] ?? 0;
            let year = parseInt(parts[2]);
            if (year < 100) year += 2500;
            return new Date(year - 543, month, day);
        }

        const parseNum = (v) => v ? parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0 : 0;

        async function fetchFromCloud(isBackground = false) {
            const icon = document.getElementById('syncIcon');
            const badge = document.querySelector('#autoSyncBadge span');
            icon.classList.add('animate-spin');
            if (badge) badge.classList.add('sync-active');
            
            try {
                const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFdX-ihIPt_qLmJz_6gYvOoP7Ql1d4ffu3BQgJBu9omjgRmmoX_w0_K00m_vvXHA/pub?output=csv";
                const response = await fetch(`${SHEET_CSV_URL}&t=${new Date().getTime()}`);
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).map(line => {
                    const res = []; let c = "", q = false;
                    for (let char of line) {
                        if (char === '"') q = !q;
                        else if (char === ',' && !q) { res.push(c); c = ""; }
                        else c += char;
                    }
                    res.push(c); return res;
                });
                processRows(rows.slice(1));
                const now = new Date();
                document.getElementById('lastUpdateText').innerText = `อัปเดตล่าสุด: ${now.toLocaleTimeString('th-TH')}`;
            } catch (err) { 
                console.error(err);
            } finally { 
                icon.classList.remove('animate-spin');
                if (badge) badge.classList.remove('sync-active');
            }
        }

        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                processRows(jsonData.slice(1));
                showStatus("นำเข้าสำเร็จ!", "success");
            };
            reader.readAsArrayBuffer(file);
        }

        function processRows(rows) {
            const expenses = new Set();
            rawData = rows.filter(r => r[2] || r[3]).map(row => {
                const expType = String(row[12] || 'ไม่ระบุ').trim();
                expenses.add(expType);
                return {
                    date: row[1] || '-',
                    dateObj: parseThaiDate(row[1]),
                    creditor: String(row[2] || '-').trim(),
                    invoice: String(row[3] || '-').trim(),
                    amount: parseNum(row[4]),
                    paid: parseNum(row[5]),
                    adjustment: parseNum(row[6]),
                    balance: parseNum(row[7]),
                    paymentDate: row[8] || '-',
                    paymentDateObj: parseThaiDate(row[8]),
                    expenseType: expType
                };
            });

            const existingMenu = document.getElementById('expenseCheckboxes');
            const sortedExps = Array.from(expenses).sort((a,b) => a.localeCompare(b, 'th'));
            
            if (existingMenu.innerHTML === "" || sortedExps.length > 0) {
                existingMenu.innerHTML = sortedExps.map(exp => `
                    <label class="flex items-center gap-2 p-1.5 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md cursor-pointer text-xs">
                        <input type="checkbox" value="${exp}" checked class="expense-item w-3 h-3 rounded text-indigo-600">
                        <span class="text-[11px] truncate text-black font-medium">${exp}</span>
                    </label>
                `).join('');

                selectedExpenseTypes = new Set(sortedExps);
                document.querySelectorAll('.expense-item').forEach(el => {
                    el.onchange = () => {
                        el.checked ? selectedExpenseTypes.add(el.value) : selectedExpenseTypes.delete(el.value);
                        updateMultiSelectLabel();
                        applyFilters();
                    };
                });
            }
            updateMultiSelectLabel();
            applyFilters();
        }

        function updateMultiSelectLabel() {
            const label = document.getElementById('selectedExpenseLabel');
            const total = document.querySelectorAll('.expense-item').length;
            const selected = selectedExpenseTypes.size;
            label.innerText = selected === total ? "ทั้งหมด" : (selected === 0 ? "ไม่ได้เลือก" : `เลือก ${selected}`);
        }

        function applyFilters() {
            const searchC = document.getElementById('searchCreditor').value.toLowerCase();
            const searchI = document.getElementById('searchInvoice').value.toLowerCase();
            const sk = document.getElementById('filterStatus').value;
            
            const rS = document.getElementById('dateReceiveStart').value ? new Date(document.getElementById('dateReceiveStart').value) : null;
            const rE = document.getElementById('dateReceiveEnd').value ? new Date(document.getElementById('dateReceiveEnd').value) : null;
            const pS = document.getElementById('datePaymentStart').value ? new Date(document.getElementById('datePaymentStart').value) : null;
            const pE = document.getElementById('datePaymentEnd').value ? new Date(document.getElementById('datePaymentEnd').value) : null;

            filteredDataGlobal = rawData.filter(d => {
                const matchC = d.creditor.toLowerCase().includes(searchC);
                const matchI = d.invoice.toLowerCase().includes(searchI);
                const matchE = selectedExpenseTypes.has(d.expenseType);
                const matchS = sk === 'All' || (sk === 'Paid' ? d.balance <= 0 : d.balance > 0);

                let mDR = true;
                if (rS && d.dateObj) { const dO = new Date(d.dateObj); dO.setHours(0,0,0,0); if (dO < rS) mDR = false; }
                if (rE && d.dateObj) { const dO = new Date(d.dateObj); dO.setHours(0,0,0,0); if (dO > rE) mDR = false; }

                let mDP = true;
                if (pS && d.paymentDateObj) { const dO = new Date(d.paymentDateObj); dO.setHours(0,0,0,0); if (dO < pS) mDP = false; } 
                else if (pS && !d.paymentDateObj) mDP = false;
                if (pE && d.paymentDateObj) { const dO = new Date(d.paymentDateObj); dO.setHours(0,0,0,0); if (dO > pE) mDP = false; }
                else if (pE && !d.paymentDateObj) mDP = false;

                return matchC && matchI && matchE && matchS && mDR && mDP;
            });
            updateUI();
        }

        function updateUI() {
            const data = filteredDataGlobal;
            const format = (v) => v.toLocaleString(undefined, {minimumFractionDigits: 2});
            const stats = data.reduce((acc, r) => ({ t: acc.t + r.amount, p: acc.p + r.paid, a: acc.a + r.adjustment, b: acc.b + r.balance }), {t:0, p:0, a:0, b:0});

            document.getElementById('statTotal').innerText = format(stats.t);
            document.getElementById('statPaid').innerText = format(stats.p);
            document.getElementById('statAdjustment').innerText = format(stats.a);
            document.getElementById('statBalance').innerText = format(stats.b);

            const expMap = {};
            data.forEach(r => {
                if (!expMap[r.expenseType]) expMap[r.expenseType] = { count: 0, amount: 0, paid: 0, adj: 0, bal: 0 };
                const m = expMap[r.expenseType];
                m.count++; m.amount += r.amount; m.paid += r.paid; m.adj += r.adjustment; m.bal += r.balance;
            });

            document.getElementById('summaryTableBody').innerHTML = Object.entries(expMap).sort().map(([type, s], idx) => `
                <tr class="hover:bg-indigo-50">
                    <td class="p-2 text-center text-black font-mono">${idx + 1}</td>
                    <td class="p-2 font-bold text-black">${type}</td>
                    <td class="p-2 text-center text-black">${s.count}</td>
                    <td class="p-2 text-right text-black font-semibold">${format(s.amount)}</td>
                    <td class="p-2 text-right text-green-800 font-semibold">${format(s.paid)}</td>
                    <td class="p-2 text-right text-orange-700 font-semibold">${format(s.adj)}</td>
                    <td class="p-2 text-right text-red-700 font-bold">${format(s.bal)}</td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="p-6 text-center text-gray-500 italic">ไม่มีข้อมูล</td></tr>';

            document.getElementById('summaryTableFooter').innerHTML = data.length ? `
                <td colspan="2" class="p-2 text-center text-black font-bold">ยอดรวมทั้งสิ้น</td>
                <td class="p-2 text-center text-black font-bold">${data.length}</td>
                <td class="p-2 text-right text-black font-bold">${format(stats.t)}</td>
                <td class="p-2 text-right text-green-800 font-bold">${format(stats.p)}</td>
                <td class="p-2 text-right text-orange-700 font-bold">${format(stats.a)}</td>
                <td class="p-2 text-right text-red-700 font-bold">${format(stats.b)}</td>
            ` : '';

            document.getElementById('dataTableBody').innerHTML = data.map(r => `
                <tr class="hover:bg-indigo-50">
                    <td class="p-2 text-black font-medium">${r.date}</td>
                    <td class="p-2">
                        <div class="font-bold text-black truncate max-w-[250px]">${r.creditor}</div>
                        <div class="text-[9px] text-indigo-700 font-bold">${r.invoice}</div>
                    </td>
                    <td class="p-2 text-right text-black font-semibold">${format(r.amount)}</td>
                    <td class="p-2 text-right text-green-800 font-semibold">${format(r.paid)}</td>
                    <td class="p-2 text-right text-orange-700 font-semibold">${format(r.adjustment)}</td>
                    <td class="p-2 text-right font-bold text-red-700">${format(r.balance)}</td>
                    <td class="p-2 text-center text-black font-medium">${r.paymentDate}</td>
                    <td class="p-2 text-center">
                        <span class="px-1.5 py-0.5 rounded text-[8px] font-bold ${r.balance <= 0 ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                            ${r.balance <= 0 ? 'ครบ' : 'ค้าง'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function showStatus(m, t) {
            const el = document.getElementById('statusMsg');
            el.innerText = m;
            el.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-[60] block text-xs ${t === 'success' ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        document.getElementById('syncCloudBtn').onclick = () => fetchFromCloud();
        document.getElementById('excelInput').onchange = handleExcelUpload;
        ['searchCreditor', 'searchInvoice', 'filterStatus', 'dateReceiveStart', 'dateReceiveEnd', 'datePaymentStart', 'datePaymentEnd'].forEach(id => {
            document.getElementById(id).oninput = applyFilters;
        });

        document.getElementById('darkModeToggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('moonIcon').classList.toggle('hidden', isDark);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
        };

        document.getElementById('checkAllExpenses').onchange = (e) => {
            document.querySelectorAll('.expense-item').forEach(item => {
                item.checked = e.target.checked;
                e.target.checked ? selectedExpenseTypes.add(item.value) : selectedExpenseTypes.delete(item.value);
            });
            updateMultiSelectLabel();
            applyFilters();
        };
    </script>
</body>
</html>
