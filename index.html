<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานเจ้าหนี้คงเหลือ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @media print {
            .no-print { display: none; }
            body { background: white; }
            .print-shadow-none { shadow: none; border: 1px solid #eee; }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center no-print">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    <span class="p-2 bg-blue-600 text-white rounded-lg shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </span>
                    รายงานเจ้าหนี้คงเหลือ
                </h1>
                <p class="text-gray-500 mt-2 flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    เชื่อมต่อข้อมูลสดจาก Google Drive
                </p>
            </div>
            <div class="flex gap-3 mt-4 md:mt-0">
                <button onclick="fetchData()" class="flex items-center gap-2 bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 transition shadow-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" id="refresh-icon" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    รีเฟรชข้อมูล
                </button>
                <button onclick="window.print()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                    พิมพ์รายงาน
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="summary-container">
            <!-- Loading placeholders -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
        </div>

        <!-- Main Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 print:border-none">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase tracking-wider text-gray-600 font-bold">
                            <th class="px-6 py-4">ค่า (รายการ)</th>
                            <th class="px-6 py-4">ประจำเดือน</th>
                            <th class="px-6 py-4 text-right">จำนวนเงิน</th>
                            <th class="px-6 py-4 text-right text-green-700">จ่าย</th>
                            <th class="px-6 py-4 text-right text-orange-700">ปรับปรุง</th>
                            <th class="px-6 py-4 text-right bg-red-50 text-red-700 font-bold">คงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center">
                                <div class="flex justify-center items-center gap-3 text-gray-400">
                                    <div class="loading-spinner"></div>
                                    กำลังดาวน์โหลดข้อมูล...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot id="table-foot" class="bg-gray-50 font-bold border-t-2 border-gray-200 hidden">
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Demo Data Notice (Only shown in preview environments) -->
        <div id="demo-notice" class="mt-4 p-3 bg-yellow-50 border border-yellow-100 rounded-lg text-yellow-700 text-xs hidden no-print">
            <strong>หมายเหตุ:</strong> ขณะนี้กำลังแสดงข้อมูลตัวอย่าง (Demo Data) เนื่องจากติดข้อจำกัดการเข้าถึงข้อมูลข้ามโดเมนในหน้า Preview นี้ หากเปิดไฟล์ในคอมพิวเตอร์ของคุณ ระบบจะแสดงข้อมูลจาก Google Sheets จริง
        </div>

        <footer class="mt-8 text-center text-xs text-gray-400 no-print">
            <p>ระบบรายงานบัญชีเจ้าหนี้ออนไลน์ &bull; อัปเดตล่าสุด: <span id="last-update">-</span></p>
        </footer>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFdX-ihIPt_qLmJz_6gYvOoP7Ql1d4ffu3BQgJBu9omjgRmmoX_w0_K00m_vvXHA/pub?gid=1374114448&single=true&output=csv";

        // ข้อมูลตัวอย่างสำหรับแสดงใน Preview
        const DEMO_DATA = [
            ["เจ้าหนี้ บจก. เอ บิสิเนส", "มกราคม 2567", "50000", "20000", "0"],
            ["ค่าเช่าอาคารสำนักงาน", "กุมภาพันธ์ 2567", "15000", "15000", "0"],
            ["ค่าไฟฟ้า - การไฟฟ้า", "มกราคม 2567", "4200.50", "4000", "-200.50"],
            ["ค่าวัสดุสำนักงาน", "มีนาคม 2567", "8500", "0", "0"],
            ["เจ้าหนี้ บจก. ที คอนซัลท์", "กุมภาพันธ์ 2567", "25000", "10000", "500"]
        ];

        const formatCurrency = (num) => {
            return new Intl.NumberFormat('th-TH', { 
                style: 'currency', 
                currency: 'THB',
                minimumFractionDigits: 2 
            }).format(num);
        };

        function updateUI(lines, isDemo = false) {
            const tableBody = document.getElementById('table-body');
            const summaryContainer = document.getElementById('summary-container');
            const tableFoot = document.getElementById('table-foot');
            const lastUpdate = document.getElementById('last-update');
            const demoNotice = document.getElementById('demo-notice');

            if (isDemo) demoNotice.classList.remove('hidden');

            const data = [];
            let totals = { amount: 0, paid: 0, adjust: 0, balance: 0 };

            // วนลูปประมวลผลข้อมูล
            lines.forEach((cols, index) => {
                // ข้ามแถวหัวตารางถ้าเป็นข้อมูลจาก CSV จริง
                if (!isDemo && index === 0) return;
                
                if (cols.length >= 3) {
                    const amount = parseFloat(cols[2]) || 0;
                    const paid = parseFloat(cols[3]) || 0;
                    const adjust = parseFloat(cols[4]) || 0;
                    const balance = amount - paid + adjust;

                    data.push({
                        name: cols[0],
                        period: cols[1],
                        amount,
                        paid,
                        adjust,
                        balance
                    });

                    totals.amount += amount;
                    totals.paid += paid;
                    totals.adjust += adjust;
                    totals.balance += balance;
                }
            });

            // แสดงการ์ดสรุป
            summaryContainer.innerHTML = `
                ${renderCard("ยอดหนี้รวม", totals.amount, "blue", "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6")}
                ${renderCard("ยอดจ่ายแล้ว", totals.paid, "green", "M13 17h8m0 0V9m0 8l-8-8-4 4-6-6")}
                ${renderCard("ปรับปรุงเจ้าหนี้", totals.adjust, "orange", "M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z")}
                ${renderCard("คงเหลือสุทธิ", totals.balance, "red", "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")}
            `;

            // แสดงตาราง
            tableBody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                    <td class="px-6 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 text-gray-500">${item.period}</td>
                    <td class="px-6 py-4 text-right font-mono">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4 text-right text-green-600 font-mono">${item.paid !== 0 ? formatCurrency(item.paid) : '0.00'}</td>
                    <td class="px-6 py-4 text-right text-orange-600 font-mono">${item.adjust !== 0 ? (item.adjust > 0 ? '+' : '') + formatCurrency(item.adjust) : '0.00'}</td>
                    <td class="px-6 py-4 text-right font-bold text-red-600 bg-red-50/30 font-mono">${formatCurrency(item.balance)}</td>
                </tr>
            `).join('');

            // แสดงยอดรวมท้ายตาราง
            tableFoot.classList.remove('hidden');
            tableFoot.innerHTML = `
                <tr class="bg-gray-100 border-t-2 border-gray-300">
                    <td class="px-6 py-4 text-gray-900" colSpan="2">รวมสุทธิ</td>
                    <td class="px-6 py-4 text-right">${formatCurrency(totals.amount)}</td>
                    <td class="px-6 py-4 text-right text-green-700">${formatCurrency(totals.paid)}</td>
                    <td class="px-6 py-4 text-right text-orange-700">${formatCurrency(totals.adjust)}</td>
                    <td class="px-6 py-4 text-right text-red-700 font-bold">${formatCurrency(totals.balance)}</td>
                </tr>
            `;

            lastUpdate.innerText = new Date().toLocaleString('th-TH');
        }

        async function fetchData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('animate-spin');

            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                const lines = csvText.split('\n').map(l => l.split(','));
                updateUI(lines, false);
            } catch (err) {
                console.warn("Fetch failed, using demo data:", err);
                // ถ้า fetch ไม่ได้ (เช่น ในหน้า Preview) ให้ใช้ Demo Data
                setTimeout(() => updateUI(DEMO_DATA, true), 500);
            } finally {
                setTimeout(() => refreshIcon.classList.remove('animate-spin'), 500);
            }
        }

        function renderCard(title, value, color, iconPath) {
            const colorClasses = {
                blue: "text-blue-600 bg-blue-50 border-blue-100",
                green: "text-green-600 bg-green-50 border-green-100",
                orange: "text-orange-600 bg-orange-50 border-orange-100",
                red: "text-red-600 bg-red-50 border-red-200 border-l-4 border-l-red-500"
            };
            return `
                <div class="bg-white p-5 rounded-xl shadow-sm border ${colorClasses[color]}">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">${title}</p>
                            <h3 class="text-xl font-bold text-gray-800">${formatCurrency(value)}</h3>
                        </div>
                        <div class="p-2 rounded-lg ${colorClasses[color]}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        }

        window.onload = fetchData;
    </script>
</body>
</html>
