<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานเจ้าหนี้ - โรงพยาบาลนางรอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-main: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: var(--bg-main);
            color: #334155;
            transition: all 0.3s ease;
        }

        .dark {
            --bg-main: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

        .row-hidden { display: none; }
        .rotate-icon { transform: rotate(90deg); }
        .transition-transform { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        .custom-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            background-color: #ffffff;
        }
        .dark .custom-table { background-color: #1e293b; }

        .custom-table th { 
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border-color);
            text-align: left;
        }
        .dark .custom-table th { background-color: #2d3748; color: #cbd5e1; }

        .custom-table td { 
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .indent-1 { padding-left: 1.5rem !important; }
        .indent-2 { padding-left: 3rem !important; }
        .indent-3 { padding-left: 4.5rem !important; }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; }
            .max-w-7xl { max-width: 100% !important; }
            .row-hidden { display: table-row !important; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="space-y-1">
                <h1 class="text-3xl font-extrabold tracking-tight text-indigo-600 dark:text-indigo-400">
                    รายงานเจ้าหนี้ <span class="text-2xl block md:inline md:ml-2">โรงพยาบาลนางรอง</span>
                </h1>
                <div class="flex items-center gap-3 text-sm text-slate-500 dark:text-slate-400">
                    <span class="flex items-center gap-1.5">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        <span id="currentDateDisplay"></span>
                    </span>
                    <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                    <span class="flex items-center gap-1.5">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        ระบบตรวจสอบภายใน
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-2 no-print">
                <button id="darkModeToggle" class="p-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm hover:border-indigo-500 transition-all">
                    <i data-lucide="moon" id="moonIcon" class="w-5 h-5 text-slate-600 dark:text-slate-400"></i>
                    <i data-lucide="sun" id="sunIcon" class="w-5 h-5 text-amber-500 hidden"></i>
                </button>
                <button id="printReportBtn" class="flex items-center gap-2 bg-slate-900 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-slate-800 transition-all font-medium">
                    <i data-lucide="printer" class="w-4 h-4"></i> พิมพ์
                </button>
                <label class="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-xl shadow-lg hover:bg-indigo-700 transition-all cursor-pointer font-medium">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> อัปโหลด
                    <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden">
                </label>
            </div>
        </header>

        <!-- Stats -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-4 mb-3">
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl">
                        <i data-lucide="wallet" class="w-6 h-6"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">ยอดหนี้รวม</p>
                </div>
                <h3 id="statTotal" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0.00</h3>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-4 mb-3">
                    <div class="p-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-2xl">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">ชำระแล้ว</p>
                </div>
                <h3 id="statPaid" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">0.00</h3>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-4 mb-3">
                    <div class="p-3 bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-2xl">
                        <i data-lucide="edit-3" class="w-6 h-6"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">ปรับปรุง</p>
                </div>
                <h3 id="statAdjustment" class="text-2xl font-bold text-amber-500 dark:text-amber-400">0.00</h3>
            </div>
            <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700/50">
                <div class="flex items-center gap-4 mb-3">
                    <div class="p-3 bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-2xl">
                        <i data-lucide="alert-circle" class="w-6 h-6"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400">คงเหลือสุทธิ</p>
                </div>
                <h3 id="statBalance" class="text-2xl font-bold text-rose-600 dark:text-rose-400">0.00</h3>
            </div>
        </section>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            
            <!-- Filter Sidebar -->
            <aside class="xl:col-span-1 space-y-6 no-print">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                            <i data-lucide="sliders-horizontal" class="w-4 h-4 text-indigo-500"></i> ตัวกรองข้อมูล
                        </h2>
                        <button id="syncCloudBtn" class="p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors" title="รีเฟรชข้อมูล">
                            <i data-lucide="refresh-cw" id="syncIcon" class="w-4 h-4 text-slate-400"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- Filter Month -->
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">เลือกเดือน (O)</label>
                            <div class="relative group">
                                <div id="monthDropdownBtn" class="w-full flex justify-between items-center px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer text-sm">
                                    <span id="selectedMonthLabel" class="truncate font-medium">กำลังโหลด...</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>
                                <div id="monthMenu" class="hidden absolute left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl z-[60] p-3">
                                    <input type="text" id="monthSearch" placeholder="ค้นหาเดือน..." class="w-full px-3 py-2 mb-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none">
                                    <div class="flex gap-2 mb-2">
                                        <button onclick="toggleAllCheckboxes('month-item', true)" class="flex-1 text-[10px] py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-md hover:bg-indigo-100 transition-colors">เลือกทั้งหมด</button>
                                        <button onclick="toggleAllCheckboxes('month-item', false)" class="flex-1 text-[10px] py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-200 transition-colors">ล้างทั้งหมด</button>
                                    </div>
                                    <div id="monthCheckboxes" class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Type -->
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">ประเภทค่าใช้จ่าย (M)</label>
                            <div class="relative group">
                                <div id="expenseTypeDropdownBtn" class="w-full flex justify-between items-center px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer text-sm">
                                    <span id="selectedExpenseLabel" class="truncate font-medium">กำลังโหลด...</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>
                                <div id="expenseMenu" class="hidden absolute left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl z-50 p-3">
                                    <input type="text" id="expenseSearch" placeholder="ค้นหาประเภท..." class="w-full px-3 py-2 mb-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none">
                                    <div class="flex gap-2 mb-2">
                                        <button onclick="toggleAllCheckboxes('expense-item', true)" class="flex-1 text-[10px] py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-md hover:bg-indigo-100 transition-colors">เลือกทั้งหมด</button>
                                        <button onclick="toggleAllCheckboxes('expense-item', false)" class="flex-1 text-[10px] py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-200 transition-colors">ล้างทั้งหมด</button>
                                    </div>
                                    <div id="expenseCheckboxes" class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Company -->
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">บริษัท (C)</label>
                            <div class="relative group">
                                <div id="companyDropdownBtn" class="w-full flex justify-between items-center px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer text-sm">
                                    <span id="selectedCompanyLabel" class="truncate font-medium">กำลังโหลด...</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </div>
                                <div id="companyMenu" class="hidden absolute left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl z-50 p-3">
                                    <input type="text" id="companySearch" placeholder="ค้นหาบริษัท..." class="w-full px-3 py-2 mb-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none">
                                    <div class="flex gap-2 mb-2">
                                        <button onclick="toggleAllCheckboxes('company-item', true)" class="flex-1 text-[10px] py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-md hover:bg-indigo-100 transition-colors">เลือกทั้งหมด</button>
                                        <button onclick="toggleAllCheckboxes('company-item', false)" class="flex-1 text-[10px] py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-md hover:bg-slate-200 transition-colors">ล้างทั้งหมด</button>
                                    </div>
                                    <div id="companyCheckboxes" class="space-y-1 max-h-48 overflow-y-auto custom-scrollbar"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Status -->
                        <div class="space-y-2">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">สถานะการชำระ (H)</label>
                            <select id="filterStatus" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 font-medium">
                                <option value="All">ทุกสถานะ</option>
                                <option value="Paid">ชำระครบแล้ว</option>
                                <option value="Unpaid">ยังมียอดค้างชำระ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Table Section -->
            <main class="xl:col-span-3">
                <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center rounded-xl">
                                <i data-lucide="table-2" class="w-5 h-5 text-indigo-600"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 dark:text-slate-100">ตารางวิเคราะห์ข้อมูล</h3>
                                <p class="text-[11px] text-slate-400">คลิกที่แถวเพื่อขยายดูข้อมูลเชิงลึก</p>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="custom-table" id="reportTable">
                            <thead>
                                <tr>
                                    <th>ประเภท</th>
                                    <th class="text-right">ยอดรวม (E)</th>
                                    <th class="text-right">จ่ายแล้ว (F)</th>
                                    <th class="text-right">ปรับปรุง (G)</th>
                                    <th class="text-right">คงเหลือ (H)</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="text-sm">
                                <tr>
                                    <td colspan="5" class="py-20 text-center text-slate-400 italic">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                                            กำลังประมวลผลข้อมูล...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr id="detailTableFooter" class="bg-slate-50/50 dark:bg-slate-900/50 font-bold"></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="statusMsg" class="hidden fixed bottom-8 right-8 p-4 rounded-2xl shadow-2xl z-[100] min-w-[280px] animate-in slide-in-from-bottom-10"></div>

    <script>
        // State Management
        let rawData = [];
        let filteredDataGlobal = [];
        let selectedExpenseTypes = new Set();
        let selectedMonths = new Set();
        let selectedCompanies = new Set();
        
        let allExpenseTypes = [];
        let allMonths = [];
        let allCompanies = [];

        lucide.createIcons();

        function updateDisplayDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', locale: 'th-TH' };
            document.getElementById('currentDateDisplay').innerText = now.toLocaleDateString('th-TH', options);
        }

        function setupDropdown(btnId, menuId) {
            const btn = document.getElementById(btnId);
            const menu = document.getElementById(menuId);
            if(!btn || !menu) return;
            btn.onclick = (e) => { 
                e.stopPropagation(); 
                const isHidden = menu.classList.contains('hidden');
                document.querySelectorAll('[id$="Menu"]').forEach(m => m.classList.add('hidden'));
                if(isHidden) menu.classList.remove('hidden'); 
            };
            document.addEventListener('click', () => menu.classList.add('hidden'));
            menu.onclick = (e) => e.stopPropagation();
        }

        setupDropdown('expenseTypeDropdownBtn', 'expenseMenu');
        setupDropdown('monthDropdownBtn', 'monthMenu');
        setupDropdown('companyDropdownBtn', 'companyMenu');

        const parseNum = (v) => v ? parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0 : 0;

        async function fetchFromCloud() {
            const icon = document.getElementById('syncIcon');
            if(icon) icon.classList.add('animate-spin');
            try {
                const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFdX-ihIPt_qLmJz_6gYvOoP7Ql1d4ffu3BQgJBu9omjgRmmoX_w0_K00m_vvXHA/pub?output=csv";
                const response = await fetch(`${SHEET_CSV_URL}&t=${new Date().getTime()}`);
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).map(line => {
                    const res = []; let c = "", q = false;
                    for (let char of line) {
                        if (char === '"') q = !q;
                        else if (char === ',' && !q) { res.push(c); c = ""; }
                        else c += char;
                    }
                    res.push(c); return res;
                });
                processRows(rows.slice(1));
                showStatus("เชื่อมต่อข้อมูลสำเร็จ", "success");
            } catch (err) { 
                showStatus("การเชื่อมต่อล้มเหลว", "error"); 
            } finally { 
                if(icon) icon.classList.remove('animate-spin'); 
            }
        }

        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                processRows(jsonData.slice(1));
                showStatus("อัปโหลดไฟล์สำเร็จ", "success");
            };
            reader.readAsArrayBuffer(file);
        }

        function processRows(rows) {
            const expenses = new Set();
            const months = new Set();
            const companies = new Set();
            
            rawData = rows.filter(r => r[12] && String(r[12]).trim() !== "" && r[12] !== 'ประเภทค่าใช้จ่าย (M)').map(row => {
                const expType = String(row[12] || 'อื่นๆ').trim();
                const monthName = String(row[14] || 'ไม่ระบุ').trim();
                const companyName = String(row[2] || 'ไม่ระบุบริษัท').trim();
                
                expenses.add(expType);
                months.add(monthName);
                companies.add(companyName);

                return {
                    company: companyName,
                    deliveryNo: String(row[3] || '-').trim(),
                    amount: parseNum(row[4]),
                    paid: parseNum(row[5]),
                    adjustment: parseNum(row[6]),
                    balance: parseNum(row[7]),
                    expenseType: expType,
                    department: monthName
                };
            });

            allExpenseTypes = Array.from(expenses).sort((a,b)=>a.localeCompare(b,'th'));
            allMonths = Array.from(months).sort((a,b)=>a.localeCompare(b,'th'));
            allCompanies = Array.from(companies).sort((a,b)=>a.localeCompare(b,'th'));

            selectedExpenseTypes = new Set(allExpenseTypes);
            selectedMonths = new Set(allMonths);
            selectedCompanies = new Set(allCompanies);

            renderCheckboxes('expenseCheckboxes', allExpenseTypes, 'expense-item', selectedExpenseTypes, 'selectedExpenseLabel');
            renderCheckboxes('monthCheckboxes', allMonths, 'month-item', selectedMonths, 'selectedMonthLabel');
            renderCheckboxes('companyCheckboxes', allCompanies, 'company-item', selectedCompanies, 'selectedCompanyLabel');

            setupSearch('monthSearch', 'monthCheckboxes');
            setupSearch('expenseSearch', 'expenseCheckboxes');
            setupSearch('companySearch', 'companyCheckboxes');

            applyFilters();
        }

        function setupSearch(inputId, containerId) {
            const input = document.getElementById(inputId);
            input.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                const labels = document.querySelectorAll(`#${containerId} label`);
                labels.forEach(l => {
                    const text = l.innerText.toLowerCase();
                    l.classList.toggle('hidden', !text.includes(term));
                });
            };
        }

        function toggleAllCheckboxes(className, state) {
            const checkboxes = document.querySelectorAll(`.${className}`);
            let setObj;
            let labelId;

            if (className === 'expense-item') { setObj = selectedExpenseTypes; labelId = 'selectedExpenseLabel'; }
            else if (className === 'month-item') { setObj = selectedMonths; labelId = 'selectedMonthLabel'; }
            else if (className === 'company-item') { setObj = selectedCompanies; labelId = 'selectedCompanyLabel'; }

            checkboxes.forEach(cb => {
                // เทคนิคคือเปลี่ยนเฉพาะตัวที่มองเห็น (ถ้ามีการ search อยู่)
                const label = cb.closest('label');
                if (!label.classList.contains('hidden')) {
                    cb.checked = state;
                    state ? setObj.add(cb.value) : setObj.delete(cb.value);
                }
            });

            updateLabel(labelId, `.${className}`, setObj.size);
            applyFilters();
        }

        function renderCheckboxes(containerId, items, className, setObj, labelId) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <label class="flex items-center gap-3 p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl cursor-pointer transition-colors filter-label">
                    <input type="checkbox" value="${item}" ${setObj.has(item) ? 'checked' : ''} class="${className} w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500/20 transition-all">
                    <span class="text-sm text-slate-600 dark:text-slate-300 font-medium truncate">${item}</span>
                </label>
            `).join('');

            document.querySelectorAll(`.${className}`).forEach(el => el.onchange = () => {
                el.checked ? setObj.add(el.value) : setObj.delete(el.value);
                updateLabel(labelId, `.${className}`, setObj.size);
                applyFilters();
            });
            updateLabel(labelId, `.${className}`, setObj.size);
        }

        function updateLabel(id, selector, count) {
            const label = document.getElementById(id);
            const total = document.querySelectorAll(selector).length;
            if (count === 0) label.innerText = "ไม่ได้เลือก";
            else if (count === total) label.innerText = "แสดงทั้งหมด";
            else label.innerText = `เลือกแล้ว ${count} รายการ`;
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            filteredDataGlobal = rawData.filter(d => {
                const matchE = selectedExpenseTypes.has(d.expenseType);
                const matchM = selectedMonths.has(d.department);
                const matchC = selectedCompanies.has(d.company);
                let matchS = true;
                if (statusFilter === 'Paid') matchS = d.balance <= 0;
                else if (statusFilter === 'Unpaid') matchS = d.balance > 0;
                return matchE && matchM && matchC && matchS;
            });
            updateUI();
        }

        function toggleRow(groupId) {
            const rows = document.querySelectorAll(`.parent-${groupId}`);
            const icon = document.getElementById(`icon-${groupId}`);
            const isExpanding = rows.length > 0 && rows[0].classList.contains('row-hidden');
            
            rows.forEach(r => {
                if(isExpanding) r.classList.remove('row-hidden');
                else r.classList.add('row-hidden');
            });
            if(icon) isExpanding ? icon.classList.add('rotate-icon') : icon.classList.remove('rotate-icon');
        }

        function updateUI() {
            const data = filteredDataGlobal;
            const format = (v) => v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            const totals = data.reduce((acc, r) => {
                acc.e += r.amount; acc.f += r.paid; acc.g += r.adjustment; acc.h += r.balance;
                return acc;
            }, {e:0, f:0, g:0, h:0});

            document.getElementById('statTotal').innerText = format(totals.e);
            document.getElementById('statPaid').innerText = format(totals.f);
            document.getElementById('statAdjustment').innerText = format(totals.g);
            document.getElementById('statBalance').innerText = format(totals.h);

            const hierarchy = {};
            data.forEach(r => {
                if (!hierarchy[r.expenseType]) hierarchy[r.expenseType] = { e: 0, f: 0, g: 0, h: 0, months: {} };
                const t = hierarchy[r.expenseType];
                t.e += r.amount; t.f += r.paid; t.g += r.adjustment; t.h += r.balance;
                
                if (!t.months[r.department]) t.months[r.department] = { e: 0, f: 0, g: 0, h: 0, companies: {} };
                const m = t.months[r.department];
                m.e += r.amount; m.f += r.paid; m.g += r.adjustment; m.h += r.balance;

                if (!m.companies[r.company]) m.companies[r.company] = { e: 0, f: 0, g: 0, h: 0, invoices: [] };
                const c = m.companies[r.company];
                c.e += r.amount; c.f += r.paid; c.g += r.adjustment; c.h += r.balance;
                c.invoices.push(r);
            });

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            Object.keys(hierarchy).sort((a,b)=>a.localeCompare(b,'th')).forEach((type, tIdx) => {
                const tData = hierarchy[type];
                const tId = `t-${tIdx}`;

                const tRow = document.createElement('tr');
                tRow.className = "cursor-pointer bg-slate-50/30 dark:bg-slate-800/20 hover:bg-indigo-50/50 dark:hover:bg-indigo-900/10 font-bold";
                tRow.onclick = () => toggleRow(tId);
                tRow.innerHTML = `
                    <td class="flex items-center gap-2">
                        <i data-lucide="chevron-right" id="icon-${tId}" class="w-4 h-4 transition-transform text-indigo-500"></i> ${type}
                    </td>
                    <td class="text-right text-blue-600 dark:text-blue-400">${format(tData.e)}</td>
                    <td class="text-right text-emerald-600 dark:text-emerald-400">${format(tData.f)}</td>
                    <td class="text-right text-amber-500 dark:text-amber-400">${format(tData.g)}</td>
                    <td class="text-right text-rose-600 dark:text-rose-400">${format(tData.h)}</td>
                `;
                tbody.appendChild(tRow);

                Object.keys(tData.months).sort((a,b)=>a.localeCompare(b,'th')).forEach((month, mIdx) => {
                    const mData = tData.months[month];
                    const mId = `m-${tIdx}-${mIdx}`;
                    const mRow = document.createElement('tr');
                    mRow.className = `parent-${tId} row-hidden cursor-pointer bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50 font-medium`;
                    mRow.onclick = (e) => { e.stopPropagation(); toggleRow(mId); };
                    mRow.innerHTML = `
                        <td class="indent-1 flex items-center gap-2">
                            <i data-lucide="chevron-right" id="icon-${mId}" class="w-3.5 h-3.5 transition-transform text-slate-400"></i>
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span> ${month}
                        </td>
                        <td class="text-right text-blue-500">${format(mData.e)}</td>
                        <td class="text-right text-emerald-500">${format(mData.f)}</td>
                        <td class="text-right text-amber-500">${format(mData.g)}</td>
                        <td class="text-right text-rose-500">${format(mData.h)}</td>
                    `;
                    tbody.appendChild(mRow);

                    Object.keys(mData.companies).sort((a,b)=>a.localeCompare(b,'th')).forEach((company, cIdx) => {
                        const cData = mData.companies[company];
                        const cId = `c-${tIdx}-${mIdx}-${cIdx}`;
                        const cRow = document.createElement('tr');
                        cRow.className = `parent-${mId} parent-${tId} row-hidden cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50`;
                        cRow.onclick = (e) => { e.stopPropagation(); toggleRow(cId); };
                        cRow.innerHTML = `
                            <td class="indent-2 flex items-center gap-2 text-slate-500 dark:text-slate-400">
                                <i data-lucide="chevron-right" id="icon-${cId}" class="w-3 h-3 transition-transform"></i>
                                <i data-lucide="building" class="w-3.5 h-3.5"></i> ${company}
                            </td>
                            <td class="text-right text-blue-500/80">${format(cData.e)}</td>
                            <td class="text-right text-emerald-500/80">${format(cData.f)}</td>
                            <td class="text-right text-amber-500/80">${format(cData.g)}</td>
                            <td class="text-right text-rose-500/80">${format(cData.h)}</td>
                        `;
                        tbody.appendChild(cRow);

                        cData.invoices.forEach(inv => {
                            const invRow = document.createElement('tr');
                            const statusColor = inv.balance <= 0 ? 'bg-emerald-500' : 'bg-rose-500';
                            invRow.className = `parent-${cId} parent-${mId} parent-${tId} row-hidden bg-slate-50/20 dark:bg-slate-900/20 text-[12px] italic text-slate-400`;
                            invRow.innerHTML = `
                                <td class="indent-3 flex items-center">
                                    <span class="status-dot ${statusColor}"></span> ${inv.deliveryNo}
                                </td>
                                <td class="text-right">${format(inv.amount)}</td>
                                <td class="text-right">${format(inv.paid)}</td>
                                <td class="text-right">${format(inv.adjustment)}</td>
                                <td class="text-right font-semibold ${inv.balance > 0 ? 'text-rose-500' : 'text-emerald-500'}">${format(inv.balance)}</td>
                            `;
                            tbody.appendChild(invRow);
                        });
                    });
                });
            });

            document.getElementById('detailTableFooter').innerHTML = `
                <td class="p-4">รวมสุทธิ</td>
                <td class="text-right text-blue-600">${format(totals.e)}</td>
                <td class="text-right text-emerald-600">${format(totals.f)}</td>
                <td class="text-right text-amber-500">${format(totals.g)}</td>
                <td class="text-right text-rose-600">${format(totals.h)}</td>
            `;
            lucide.createIcons();
        }

        function showStatus(m, t) {
            const el = document.getElementById('statusMsg');
            const icon = t === 'success' ? 'check-circle' : 'alert-circle';
            const color = t === 'success' ? 'bg-emerald-600' : 'bg-rose-600';
            
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-white/20 rounded-lg"><i data-lucide="${icon}" class="w-5 h-5 text-white"></i></div>
                    <span class="font-medium text-white">${m}</span>
                </div>
            `;
            el.className = `fixed bottom-8 right-8 p-4 rounded-2xl shadow-2xl z-[100] block ${color} animate-in slide-in-from-right-10`;
            el.classList.remove('hidden');
            lucide.createIcons();
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        document.getElementById('darkModeToggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('moonIcon').classList.toggle('hidden', isDark);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
        };

        document.getElementById('printReportBtn').onclick = () => window.print();
        document.getElementById('syncCloudBtn').onclick = fetchFromCloud;
        document.getElementById('excelInput').onchange = handleExcelUpload;
        document.getElementById('filterStatus').onchange = applyFilters;

        window.onload = () => { 
            updateDisplayDate();
            fetchFromCloud(); 
            setInterval(fetchFromCloud, 300000); 
        };
    </script>
</body>
</html>
